function GifWriter(a,b,c,d){function e(a){var b=a.length;if(2>b||b>256||b&b-1)throw"Invalid code/color length ("+b+"), must be power of 2 and 2 .. 256.";return b}var f=0,d=void 0===d?{}:d,g=void 0===d.loop?null:d.loop,h=void 0===d.palette?null:d.palette;if(0>=b||0>=c||b>65535||c>65535)throw"Width/Height invalid.";a[f++]=71,a[f++]=73,a[f++]=70,a[f++]=56,a[f++]=57,a[f++]=97;var i=0,j=0;if(null!==h){for(var k=e(h);k>>=1;)++i;if(k=1<<i,--i,void 0!==d.background){if(j=d.background,j>=k)throw"Background index out of range.";if(0===j)throw"Background index explicitly passed as 0."}}if(a[f++]=255&b,a[f++]=b>>8&255,a[f++]=255&c,a[f++]=c>>8&255,a[f++]=(null!==h?128:0)|i,a[f++]=j,a[f++]=0,null!==h)for(var l=0,m=h.length;m>l;++l){var n=h[l];a[f++]=n>>16&255,a[f++]=n>>8&255,a[f++]=255&n}if(null!==g){if(0>g||g>65535)throw"Loop count invalid.";a[f++]=33,a[f++]=255,a[f++]=11,a[f++]=78,a[f++]=69,a[f++]=84,a[f++]=83,a[f++]=67,a[f++]=65,a[f++]=80,a[f++]=69,a[f++]=50,a[f++]=46,a[f++]=48,a[f++]=3,a[f++]=1,a[f++]=255&g,a[f++]=g>>8&255,a[f++]=0}var o=!1;this.addFrame=function(b,c,d,g,i,j){if(o===!0&&(--f,o=!1),j=void 0===j?{}:j,0>b||0>c||b>65535||c>65535)throw"x/y invalid.";if(0>=d||0>=g||d>65535||g>65535)throw"Width/Height invalid.";if(i.length<d*g)throw"Not enough pixels for the frame size.";var k=!0,l=j.palette;if((void 0===l||null===l)&&(k=!1,l=h),void 0===l||null===l)throw"Must supply either a local or global palette.";for(var m=e(l),n=0;m>>=1;)++n;m=1<<n;var p=void 0===j.delay?0:j.delay,q=void 0===j.disposal?0:j.disposal;if(0>q||q>3)throw"Disposal out of range.";var r=!1,s=0;if(void 0!==j.transparent&&null!==j.transparent&&(r=!0,s=j.transparent,0>s||s>=m))throw"Transparent color index.";if((0!==q||r||0!==p)&&(a[f++]=33,a[f++]=249,a[f++]=4,a[f++]=q<<2|(r===!0?1:0),a[f++]=255&p,a[f++]=p>>8&255,a[f++]=s,a[f++]=0),a[f++]=44,a[f++]=255&b,a[f++]=b>>8&255,a[f++]=255&c,a[f++]=c>>8&255,a[f++]=255&d,a[f++]=d>>8&255,a[f++]=255&g,a[f++]=g>>8&255,a[f++]=k===!0?128|n-1:0,k===!0)for(var t=0,u=l.length;u>t;++t){var v=l[t];a[f++]=v>>16&255,a[f++]=v>>8&255,a[f++]=255&v}f=GifWriterOutputLZWCodeStream(a,f,2>n?2:n,i)},this.end=function(){return o===!1&&(a[f++]=59,o=!0),f}}function GifWriterOutputLZWCodeStream(a,b,c,d){function e(c){for(;m>=c;)a[b++]=255&n,n>>=8,m-=8,b===g+256&&(a[g]=255,g=b++)}function f(a){n|=a<<m,m+=l,e(8)}a[b++]=c;var g=b++,h=1<<c,i=h-1,j=h+1,k=j+1,l=c+1,m=0,n=0,o=d[0]&i,p={};f(h);for(var q=1,r=d.length;r>q;++q){var s=d[q]&i,t=o<<8|s,u=p[t];if(void 0===u){for(n|=o<<m,m+=l;m>=8;)a[b++]=255&n,n>>=8,m-=8,b===g+256&&(a[g]=255,g=b++);4096===k?(f(h),k=j+1,l=c+1,p={}):(k>=1<<l&&++l,p[t]=k++),o=s}else o=u}return f(o),f(j),e(1),g+1===b?a[g]=0:(a[g]=b-g-1,a[b++]=0),b}function GifReader(a){var b=0;if(71!==a[b++]||73!==a[b++]||70!==a[b++]||56!==a[b++]||57!==a[b++]||97!==a[b++])throw"Invalid GIF 89a header.";{var c=a[b++]|a[b++]<<8,d=a[b++]|a[b++]<<8,e=a[b++],f=e>>7,g=7&e,h=1<<g+1;a[b++]}a[b++];var i=null;f&&(i=b,b+=3*h);var j=null,k=!0,l=[],m=0,n=null,o=0,j=null;for(this.width=c,this.height=d;k&&b<a.length;)switch(a[b++]){case 33:switch(a[b++]){case 255:if(11!==a[b]||78==a[b+1]&&69==a[b+2]&&84==a[b+3]&&83==a[b+4]&&67==a[b+5]&&65==a[b+6]&&80==a[b+7]&&69==a[b+8]&&50==a[b+9]&&46==a[b+10]&&48==a[b+11]&&3==a[b+12]&&1==a[b+13]&&0==a[b+16])b+=14,j=a[b++]|a[b++]<<8,b++;else for(b+=12;;){var p=a[b++];if(0===p)break;b+=p}break;case 249:if(4!==a[b++]||0!==a[b+4])throw"Invalid graphics extension block.";var q=a[b++];m=a[b++]|a[b++]<<8,n=a[b++],0===(1&q)&&(n=null),o=q>>2&7,b++;break;case 254:for(;;){var p=a[b++];if(0===p)break;b+=p}break;default:throw"Unknown graphic control label: 0x"+a[b-1].toString(16)}break;case 44:var r=a[b++]|a[b++]<<8,s=a[b++]|a[b++]<<8,t=a[b++]|a[b++]<<8,u=a[b++]|a[b++]<<8,v=a[b++],w=v>>7,x=7&v,y=1<<x+1,z=i,A=!1;if(w){var A=!0;z=b,b+=3*y}var B=b;for(b++;;){var p=a[b++];if(0===p)break;b+=p}l.push({x:r,y:s,width:t,height:u,has_local_palette:A,palette_offset:z,data_offset:B,data_length:b-B,transparent_index:n,delay:m,disposal:o});break;case 59:k=!1;break;default:throw"Unknown gif block: 0x"+a[b-1].toString(16)}this.numFrames=function(){return l.length},this.frameInfo=function(a){if(0>a||a>=l.length)throw"Frame index out of range.";return l[a]},this.decodeAndBlitFrameBGRA=function(b,d){var e=this.frameInfo(b),f=e.width*e.height,g=new Uint8Array(f);GifReaderLZWOutputIndexStream(a,e.data_offset,g,f);var h=e.palette_offset,i=e.transparent_index;null===i&&(i=256);for(var j=4*(c-e.width),k=4*(e.y*c+e.x),l=e.width,m=0,n=g.length;n>m;++m){var o=g[m];if(o===i)k+=4;else{var p=a[h+3*o],q=a[h+3*o+1],r=a[h+3*o+2];d[k++]=r,d[k++]=q,d[k++]=p,d[k++]=255}0===--l&&(k+=j,l=e.width)}},this.decodeAndBlitFrameRGBA=function(b,d){var e=this.frameInfo(b),f=e.width*e.height,g=new Uint8Array(f);GifReaderLZWOutputIndexStream(a,e.data_offset,g,f);var h=0,i=e.palette_offset,j=e.transparent_index;null===j&&(j=256);for(var k=4*(c-e.width),h=4*(e.y*c+e.x),l=e.width,m=0,n=g.length;n>m;++m){var o=g[m];if(o===j)h+=4;else{var p=a[i+3*o],q=a[i+3*o+1],r=a[i+3*o+2];d[h++]=p,d[h++]=q,d[h++]=r,d[h++]=255}0===--l&&(h+=k,l=e.width)}}}function GifReaderLZWOutputIndexStream(a,b,c,d){for(var e=a[b++],f=1<<e,g=f+1,h=g+1,i=e+1,j=(1<<i)-1,k=0,l=0,m=0,n=a[b++],o=new Int32Array(4096),p=null;;){for(;16>k&&0!==n;)l|=a[b++]<<k,k+=8,1===n?n=a[b++]:--n;if(i>k)break;var q=l&j;if(l>>=i,k-=i,q!==f){if(q===g)break;for(var r=h>q?q:p,s=0,t=r;t>f;)t=o[t]>>8,++s;var u=t,v=m+s+(r!==q?1:0);if(v>d)return void console.log("Warning, gif stream longer than expected.");c[m++]=u,m+=s;var w=m;for(r!==q&&(c[m++]=u),t=r;s--;)t=o[t],c[--w]=255&t,t>>=8;null!==p&&4096>h&&(o[h++]=p<<8|u,h>=j+1&&12>i&&(++i,j=j<<1|1)),p=q}else h=g+1,i=e+1,j=(1<<i)-1,p=null}return m!==d&&console.log("Warning, gif stream shorter than expected."),c}try{exports.GifWriter=GifWriter,exports.GifReader=GifReader}catch(e){}